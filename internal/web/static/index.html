<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Arbitrage Engine Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #0056b3; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .exchange-pair { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1 1 45%; min-width: 300px; }
        .bbo { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .bbo p { margin: 5px 0; }
        .bbo .bid { color: green; font-weight: bold; }
        .bbo .ask { color: red; font-weight: bold; }
        .orderbook { margin-top: 15px; display: flex; gap: 10px; }
        .orderbook-side { flex: 1; }
        .orderbook-side h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .orderbook-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .orderbook-list li { display: flex; justify-content: space-between; padding: 3px 0; font-size: 0.9em; }
        .orderbook-list li span { flex: 1; text-align: right; padding: 0 5px; }
        .orderbook-list li .price { font-weight: bold; }
        .orderbook-list li .bid-price { color: green; }
        .orderbook-list li .ask-price { color: red; }
        .status { font-size: 0.8em; color: #666; margin-top: 5px; text-align: right; }
        .timestamp { font-size: 0.8em; color: #666; text-align: right; margin-top: 5px; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Crypto Arbitrage Engine Dashboard</h1>

    <div id="status">Connecting to WebSocket...</div>

    <div class="container" id="data-container">
        <!-- Data for each exchange/pair will be inserted here by JavaScript -->

        <!-- Example structure (will be generated by JS):
        <div class="exchange-pair" id="binance-BTCUSDT">
            <h2>Binance BTCUSDT</h2>
            <div class="status">Status: Synced</div>
            <div class="bbo">
                <p>Best Bid: <span class="bid price">93967.66</span> (Qty: <span>1.18496</span>)</p>
                <p>Best Ask: <span class="ask price">93967.67</span> (Qty: <span>8.23605</span>)</p>
            </div>
            <div class="timestamp">Last Update: 2025-05-06 16:43:54</div>
            <div class="orderbook">
                <div class="orderbook-side bids">
                    <h3>Bids</h3>
                    <ul class="orderbook-list">
                        <li><span class="price bid-price">93967.66</span> <span>1.18496</span></li>
                        ...
                    </ul>
                </div>
                <div class="orderbook-side asks">
                    <h3>Asks</h3>
                     <ul class="orderbook-list">
                        <li><span class="price ask-price">93967.67</span> <span>8.23605</span></li>
                        ...
                    </ul>
                </div>
            </div>
        </div>
        -->

    </div>

    <script>
        const wsUrl = `ws://${window.location.host}/ws`; // Use current host for WebSocket URL
        let websocket;

        function connectWebSocket() {
            websocket = new WebSocket(wsUrl);

            websocket.onopen = function(event) {
                console.log("WebSocket connected:", event);
                document.getElementById('status').innerText = 'WebSocket Status: Connected';
                document.getElementById('status').style.color = 'green';
            };

            websocket.onmessage = function(event) {
                // console.log("WebSocket message received:", event.data);
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === "orderbook_update" && data.data) {
                        updateDisplay(data.data);
                    } else {
                        console.warn("Received unknown message type or format:", data);
                    }
                } catch (e) {
                    console.error("Error parsing WebSocket message:", e, event.data);
                }
            };

            websocket.onerror = function(event) {
                console.error("WebSocket error observed:", event);
                document.getElementById('status').innerText = 'WebSocket Status: Error';
                document.getElementById('status').style.color = 'red';
            };

            websocket.onclose = function(event) {
                console.log("WebSocket connection closed:", event);
                 document.getElementById('status').innerText = `WebSocket Status: Closed (Code: ${event.code}, Reason: ${event.reason})`;
                 document.getElementById('status').style.color = 'orange';

                // Attempt to reconnect after a delay
                setTimeout(connectWebSocket, 5000); // Reconnect after 5 seconds
            };
        }

        function updateDisplay(data) {
            const container = document.getElementById('data-container');

            for (const source in data) {
                for (const symbol in data[source]) {
                    const exchangeData = data[source][symbol];
                    const id = `${source}-${symbol}`;

                    let pairDiv = document.getElementById(id);
                    if (!pairDiv) {
                        // Create the main div for this exchange/pair if it doesn't exist
                        pairDiv = document.createElement('div');
                        pairDiv.classList.add('exchange-pair');
                        pairDiv.id = id;
                        pairDiv.innerHTML = `
                            <h2>${source.charAt(0).toUpperCase() + source.slice(1)} ${symbol}</h2>
                            <div class="status">Status: N/A</div>
                            <div class="bbo">
                                <p>Best Bid: <span class="bid price">-</span> (Qty: <span>-</span>)</p>
                                <p>Best Ask: <span class="ask price">-</span> (Qty: <span>-</span>)</p>
                            </div>
                            <div class="timestamp">Last Update: N/A</div>
                            <div class="orderbook">
                                <div class="orderbook-side bids">
                                    <h3>Bids</h3>
                                    <ul class="orderbook-list"></ul>
                                </div>
                                <div class="orderbook-side asks">
                                    <h3>Asks</h3>
                                    <ul class="orderbook-list"></ul>
                                </div>
                            </div>
                        `;
                        container.appendChild(pairDiv);
                    }

                    // Update status
                    const statusDiv = pairDiv.querySelector('.status');
                    if (exchangeData.sync_status) {
                         statusDiv.innerText = `Status: ${exchangeData.sync_status}`;
                         statusDiv.style.color = exchangeData.sync_status === 'Synced' ? 'green' :
                                                 exchangeData.sync_status.includes('Error') || exchangeData.sync_status.includes('Gap') ? 'red' :
                                                 'orange'; // Initializing, Waiting, Resyncing etc.
                    } else {
                         statusDiv.innerText = 'Status: Unknown';
                         statusDiv.style.color = '#666';
                    }


                    // Update BBO
                    const bboDiv = pairDiv.querySelector('.bbo');
                    if (exchangeData.bbo) {
                        bboDiv.querySelector('.bid.price').innerText = exchangeData.bbo.best_bid.toFixed(8); // Format as needed
                        bboDiv.querySelector('.bbo .bid + span').innerText = exchangeData.bbo.best_bid_quantity.toFixed(8); // Format as needed
                        bboDiv.querySelector('.ask.price').innerText = exchangeData.bbo.best_ask.toFixed(8); // Format as needed
                         bboDiv.querySelector('.bbo .ask + span').innerText = exchangeData.bbo.best_ask_quantity.toFixed(8); // Format as needed
                    } else {
                        bboDiv.querySelector('.bid.price').innerText = '-';
                        bboDiv.querySelector('.bbo .bid + span').innerText = '-';
                        bboDiv.querySelector('.ask.price').innerText = '-';
                        bboDiv.querySelector('.bbo .ask + span').innerText = '-';
                    }

                    // Update timestamp
                    const timestampDiv = pairDiv.querySelector('.timestamp');
                     if (exchangeData.orderbook && exchangeData.orderbook.timestamp) {
                         // Format timestamp nicely
                         const date = new Date(exchangeData.orderbook.timestamp);
                         timestampDiv.innerText = `Last Update: ${date.toLocaleTimeString()} (ID: ${exchangeData.orderbook.update_id})`;
                     } else {
                          timestampDiv.innerText = 'Last Update: N/A';
                     }


                    // Update Order Book
                    if (exchangeData.orderbook) {
                        const bidsList = pairDiv.querySelector('.orderbook-side.bids .orderbook-list');
                        const asksList = pairDiv.querySelector('.orderbook-side.asks .orderbook-list');

                        // Clear existing lists
                        bidsList.innerHTML = '';
                        asksList.innerHTML = '';

                        // Populate Bids
                        exchangeData.orderbook.bids.forEach(level => {
                            const li = document.createElement('li');
                            li.innerHTML = `<span class="price bid-price">${level.price.toFixed(8)}</span> <span>${level.amount.toFixed(8)}</span>`; // Format as needed
                            bidsList.appendChild(li);
                        });

                        // Populate Asks
                        exchangeData.orderbook.asks.forEach(level => {
                            const li = document.createElement('li');
                            li.innerHTML = `<span class="price ask-price">${level.price.toFixed(8)}</span> <span>${level.amount.toFixed(8)}</span>`; // Format as needed
                            asksList.appendChild(li);
                        });
                    } else {
                         // Clear order book lists if no data
                          pairDiv.querySelector('.orderbook-side.bids .orderbook-list').innerHTML = '';
                          pairDiv.querySelector('.orderbook-side.asks .orderbook-list').innerHTML = '';
                    }
                }
            }
        }

        // Connect WebSocket when the page loads
        window.onload = connectWebSocket;
    </script>
</body>
</html>